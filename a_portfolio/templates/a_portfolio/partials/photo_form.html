<form method="post" enctype="multipart/form-data" class="space-y-6" hx-encoding="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}
    
    <div class="grid gap-4">
        {% for field in form %}
            {% if field.name != 'images' %}
            <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">{{ field.label }}</label>
                <div class="mt-1">{{ field }}</div>
                {% if field.help_text %}<p class="text-xs text-gray-500">{{ field.help_text }}</p>{% endif %}
                <div class="text-red-600 text-sm">{{ field.errors }}</div>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Image Upload Section -->
    <div class="space-y-3">
        <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-700">Images</label>
            <span id="image-count" class="text-xs text-gray-500 hidden">0 images selected</span>
        </div>
        
        <div class="relative">
            <label for="id_images" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="mb-2 text-sm text-gray-500">
                        <span class="font-semibold">Click to upload</span> or drag and drop
                    </p>
                    <p class="text-xs text-gray-500">PNG, JPG, GIF, WebP (MAX. 10MB each)</p>
                    <p class="text-xs text-gray-400 mt-1">You can select multiple images</p>
                </div>
                <!-- Visually hidden native file input; handled by custom dropzone + JS -->
                <input
                    type="file"
                    name="images"
                    id="id_images"
                    class="sr-only"
                    multiple
                    accept="image/*"
                />
            </label>
        </div>
        <div class="text-red-600 text-sm">{{ form.images.errors }}</div>
    </div>

    <!-- Image Preview Grid -->
    <div id="image-preview-container" class="hidden">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-700">Selected Images</h3>
            <button type="button" id="clear-all-images" class="text-xs text-red-600 hover:text-red-700 font-medium">
                Clear all
            </button>
        </div>
        <div id="image-preview-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <!-- Preview thumbnails will be inserted here -->
        </div>
    </div>

    <div class="flex gap-3 pt-4 border-t border-gray-200">
        <button type="submit" class="button" id="submit-btn">
            <span id="submit-text">Upload Images</span>
            <span id="submit-loading" class="hidden">Uploading...</span>
        </button>
        <a href="{% url 'portfolio' %}" class="button button-gray">Cancel</a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.querySelector('#id_images');
    const previewContainer = document.getElementById('image-preview-container');
    const previewGrid = document.getElementById('image-preview-grid');
    const imageCount = document.getElementById('image-count');
    const clearAllBtn = document.getElementById('clear-all-images');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');
    
    let selectedFiles = [];
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function updatePreview() {
        if (selectedFiles.length === 0) {
            previewContainer.classList.add('hidden');
            imageCount.classList.add('hidden');
            return;
        }
        
        previewContainer.classList.remove('hidden');
        imageCount.classList.remove('hidden');
        imageCount.textContent = `${selectedFiles.length} image${selectedFiles.length !== 1 ? 's' : ''} selected`;
        
        previewGrid.innerHTML = '';
        
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'relative group bg-gray-100 rounded-lg overflow-hidden border border-gray-200';
                div.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}" class="w-full h-32 object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-opacity flex items-center justify-center">
                        <button type="button" class="remove-image-btn opacity-0 group-hover:opacity-100 bg-red-600 text-white rounded-full p-2 hover:bg-red-700 transition-opacity" data-index="${index}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-2 bg-white">
                        <p class="text-xs font-medium text-gray-700 truncate" title="${file.name}">${file.name}</p>
                        <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                    </div>
                `;
                previewGrid.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }
    
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            selectedFiles = files;
            updatePreview();
        });
    }
    
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function() {
            selectedFiles = [];
            if (imageInput) {
                imageInput.value = '';
            }
            updatePreview();
        });
    }
    
    // Handle remove individual image
    previewGrid.addEventListener('click', function(e) {
        if (e.target.closest('.remove-image-btn')) {
            const index = parseInt(e.target.closest('.remove-image-btn').dataset.index);
            selectedFiles.splice(index, 1);
            
            // Update the file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            if (imageInput) {
                imageInput.files = dt.files;
            }
            
            updatePreview();
        }
    });
    
    // Show loading state on submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function() {
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');
            submitBtn.disabled = true;
        });
    }
});
</script>

